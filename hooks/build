#!/usr/bin/env python
from __future__ import print_function
import json
import logging
import os
from datetime import datetime
from glob import iglob

import docker

logging.basicConfig(level=logging.INFO)
DEFAULT_VERSION = "11.0"
DOCKER_REPO = os.environ.get("DOCKER_REPO", "tecnativa/odoo-base")
CLIENT = docker.client.from_env()
GIT_SHA1 = os.environ.get("GIT_SHA1", "")

# Build version-specific images
for dockerfile in iglob("*.Dockerfile"):
    version = dockerfile.replace(".Dockerfile", "")
    logging.info("Building image for version %s", version)
    # Low-level api for building images and streaming output
    response = CLIENT.api.build(
        path=".",
        dockerfile=dockerfile,
        tag=u"{}:{}".format(DOCKER_REPO, version),
        buildargs={
            "BUILD_DATE": datetime.utcnow().isoformat(),
            "ODOO_VERSION": version,
            "VCS_REF": GIT_SHA1,
        }
    )
    status = None
    for line in response:
        line = json.loads(line)
        if line.get("status") not in {status, None}:
            status = line["status"]
            print(status)
        if line.get("stream"):
            print(line["stream"]), end="")

# Tag default version
logging.info("Tagging latest")
image = CLIENT.images.get(u"{}:{}".format(DOCKER_REPO, DEFAULT_VERSION))
image.tag(DOCKER_REPO, "latest")
